---
- name: Deploy Trading Brain
  hosts: trading
  vars:
    deploy_dir: /srv/trading-brain
    project_root: "{{ playbook_dir }}/.."

  tasks:
    # --- Docker Installation ---

    - name: Check if Docker is installed
      command: docker --version
      register: docker_check
      ignore_errors: true
      changed_when: false
      tags: [setup]

    - name: Install Docker (Arch Linux)
      when: docker_check.rc != 0 and ansible_os_family == "Archlinux"
      block:
        - name: Install docker and docker-compose
          pacman:
            name:
              - docker
              - docker-compose
            state: present
      tags: [setup]

    - name: Install Docker (Debian/Ubuntu)
      when: docker_check.rc != 0 and ansible_os_family == "Debian"
      block:
        - name: Install prerequisites
          apt:
            name: [ca-certificates, curl, gnupg]
            state: present
            update_cache: true

        - name: Add Docker GPG key
          shell: |
            install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            chmod a+r /etc/apt/keyrings/docker.gpg
          args:
            creates: /etc/apt/keyrings/docker.gpg

        - name: Add Docker repository
          shell: |
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/{{ ansible_distribution | lower }} $(. /etc/os-release && echo $VERSION_CODENAME) stable" > /etc/apt/sources.list.d/docker.list
          args:
            creates: /etc/apt/sources.list.d/docker.list

        - name: Install Docker packages
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-compose-plugin
            state: present
            update_cache: true
      tags: [setup]

    - name: Enable and start Docker
      systemd:
        name: docker
        enabled: true
        state: started
      tags: [setup]

    - name: Add deploy user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true
      tags: [setup]

    - name: Install Loki Docker log driver
      command: docker plugin install grafana/loki-docker-driver:3.4.0 --alias loki --grant-all-permissions
      register: loki_driver
      failed_when: loki_driver.rc != 0 and "already exists" not in loki_driver.stderr
      changed_when: loki_driver.rc == 0
      tags: [setup]

    - name: Install sqlite3 (for monitoring and debugging)
      apt:
        name: sqlite3
        state: present
      when: ansible_os_family == "Debian"
      tags: [setup]

    # --- Directory Structure ---

    - name: Create deployment directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"
      loop:
        - "{{ deploy_dir }}"
        - "{{ deploy_dir }}/data"
        - "{{ deploy_dir }}/config"
        - "{{ deploy_dir }}/strategy/active"
        - "{{ deploy_dir }}/strategy/archive"
        - "{{ deploy_dir }}/statistics/active"
        - "{{ deploy_dir }}/statistics/archive"
        - "{{ deploy_dir }}/monitoring/grafana/provisioning/datasources"
        - "{{ deploy_dir }}/monitoring/grafana/provisioning/dashboards/json"
      tags: [sync]

    # --- Sync Project Files ---

    - name: Sync project source
      synchronize:
        src: "{{ project_root }}/src/"
        dest: "{{ deploy_dir }}/src/"
        delete: true
        rsync_opts:
          - "--exclude=__pycache__"
      tags: [sync]
      notify: restart container

    - name: Sync strategy files
      synchronize:
        src: "{{ project_root }}/strategy/"
        dest: "{{ deploy_dir }}/strategy/"
        rsync_opts:
          - "--exclude=__pycache__"
      tags: [sync]

    - name: Sync statistics files
      synchronize:
        src: "{{ project_root }}/statistics/"
        dest: "{{ deploy_dir }}/statistics/"
        rsync_opts:
          - "--exclude=__pycache__"
      tags: [sync]

    - name: Sync config files
      synchronize:
        src: "{{ project_root }}/config/"
        dest: "{{ deploy_dir }}/config/"
      tags: [sync]
      notify: restart container

    - name: Sync monitoring config
      synchronize:
        src: "{{ project_root }}/monitoring/"
        dest: "{{ deploy_dir }}/monitoring/"
        delete: true
      tags: [sync]
      notify: restart container

    - name: Sync build files
      copy:
        src: "{{ item.src }}"
        dest: "{{ deploy_dir }}/{{ item.dest }}"
        mode: "0644"
      loop:
        - { src: "{{ project_root }}/Dockerfile", dest: "Dockerfile" }
        - { src: "{{ project_root }}/docker-compose.yml", dest: "docker-compose.yml" }
        - { src: "{{ project_root }}/pyproject.toml", dest: "pyproject.toml" }
      tags: [sync]
      notify: rebuild container

    # --- Secrets ---

    - name: Deploy .env file
      template:
        src: templates/env.j2
        dest: "{{ deploy_dir }}/.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"
      tags: [secrets]
      notify: restart container

    # --- Build and Start ---

    - name: Build container image
      community.docker.docker_compose_v2:
        project_src: "{{ deploy_dir }}"
        build: always
        state: present
      tags: [build]

    - name: Start container
      community.docker.docker_compose_v2:
        project_src: "{{ deploy_dir }}"
        state: present
      register: compose_result
      tags: [start]

    # --- Verify ---

    - name: Wait for container to be running
      command: docker inspect --format '{{ '{{' }}.State.Running{{ '}}' }}' trading-brain
      register: container_state
      retries: 10
      delay: 3
      until: container_state.stdout == "true"
      changed_when: false
      tags: [verify]

    - name: Show recent logs
      command: docker compose -f {{ deploy_dir }}/docker-compose.yml logs --tail=30
      register: logs
      changed_when: false
      tags: [verify]

    - name: Display logs
      debug:
        msg: "{{ logs.stdout_lines }}"
      tags: [verify]

    # --- Reverse Proxy (Caddy) ---

    - name: Install Caddy (Debian/Ubuntu)
      when: ansible_os_family == "Debian"
      block:
        - name: Add Caddy GPG key
          shell: |
            curl -fsSL https://dl.cloudsmith.io/public/caddy/stable/gpg.key | gpg --dearmor -o /etc/apt/keyrings/caddy.gpg
          args:
            creates: /etc/apt/keyrings/caddy.gpg

        - name: Add Caddy repository
          shell: |
            echo "deb [signed-by=/etc/apt/keyrings/caddy.gpg] https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main" > /etc/apt/sources.list.d/caddy.list
          args:
            creates: /etc/apt/sources.list.d/caddy.list

        - name: Install Caddy
          apt:
            name: caddy
            state: present
            update_cache: true
      tags: [caddy]

    - name: Install Caddy (Arch Linux)
      when: ansible_os_family == "Archlinux"
      pacman:
        name: caddy
        state: present
      tags: [caddy]

    - name: Deploy Caddyfile
      template:
        src: templates/Caddyfile.j2
        dest: /etc/caddy/Caddyfile
        mode: "0644"
      notify: reload caddy
      tags: [caddy]

    - name: Allow HTTP through firewall
      ufw:
        rule: allow
        port: "80"
        proto: tcp
      tags: [caddy]

    - name: Allow HTTPS through firewall
      ufw:
        rule: allow
        port: "443"
        proto: tcp
      tags: [caddy]

    - name: Allow Grafana through firewall
      ufw:
        rule: allow
        port: "3000"
        proto: tcp
      tags: [caddy]

    - name: Enable and start Caddy
      systemd:
        name: caddy
        enabled: true
        state: started
      tags: [caddy]

  handlers:
    - name: rebuild container
      community.docker.docker_compose_v2:
        project_src: "{{ deploy_dir }}"
        build: always
        state: present
        recreate: always

    - name: restart container
      command: docker compose -f {{ deploy_dir }}/docker-compose.yml up -d --force-recreate

    - name: reload caddy
      systemd:
        name: caddy
        state: reloaded
